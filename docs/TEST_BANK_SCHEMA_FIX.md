# Test Bank Database Schema Fix

## Issue
Test bank submission was failing with error:
```
Could not find the 'file_path' column of 'test_bank' in the schema cache
```

## Root Cause
The code was using outdated column names that didn't match the actual database schema.

**Code was using:**
- `file_path` 
- `file_name`

**Actual database columns:**
- `stored_file_name` (the path/name of the file in storage)
- `original_file_name` (the original name of the uploaded file)

## Database Schema
Based on your provided columns, the `test_bank` table has:
```
id                  - UUID primary key
submitted_by        - UUID (user who submitted)
class_code          - VARCHAR (course code)
file_type           - VARCHAR ('test', 'notes', 'materials')
original_file_name  - TEXT (original uploaded filename)
stored_file_name    - TEXT (storage path/filename)
uploaded_at         - TIMESTAMP
status              - VARCHAR ('pending', 'approved', 'rejected')
reviewed_by         - UUID (officer who reviewed)
notes               - TEXT (review notes)
file_name           - TEXT (deprecated/legacy column?)
updated_at          - TIMESTAMP
```

## Files Fixed

### 1. `app/(tabs)/account.tsx`

**Test Bank Insert Query:**
```typescript
// BEFORE
.insert({
  class_code: testBankClassCode.toUpperCase(),
  file_type: testBankFileType,
  file_name: testBankSelectedFile.name,      // ❌ Wrong
  file_path: uploadResult.filePath,          // ❌ Wrong
  submitted_by: user.id,
  status: 'pending',
})

// AFTER
.insert({
  class_code: testBankClassCode.toUpperCase(),
  file_type: testBankFileType,
  original_file_name: testBankSelectedFile.name,  // ✅ Correct
  stored_file_name: uploadResult.filePath,        // ✅ Correct
  submitted_by: user.id,
  status: 'pending',
})
```

**Test Bank Fetch Query:**
```typescript
// BEFORE
.select('id, class_code, file_type, file_name, uploaded_at, status')

// AFTER
.select('id, class_code, file_type, original_file_name, uploaded_at, status')
```

### 2. `components/AccountSections/TestBankSection.tsx`

**TypeScript Interface:**
```typescript
// BEFORE
export interface TestBankSubmission {
  id: string;
  class_code: string;
  file_type: 'test' | 'notes' | 'materials';
  file_name: string;              // ❌ Wrong
  uploaded_at: string;
  status: 'pending' | 'approved' | 'rejected';
}

// AFTER
export interface TestBankSubmission {
  id: string;
  class_code: string;
  file_type: 'test' | 'notes' | 'materials';
  original_file_name: string;     // ✅ Correct
  uploaded_at: string;
  status: 'pending' | 'approved' | 'rejected';
}
```

**Display Code:**
```typescript
// BEFORE
<Text style={styles.fileName}>
  {submission.file_name}
</Text>

// AFTER
<Text style={styles.fileName}>
  {submission.original_file_name}
</Text>
```

## Column Usage Explanation

### `original_file_name`
The original name of the file as uploaded by the user (e.g., "CS101_Midterm_Spring2025.pdf")
- Used for display to the user
- Shown in submission lists
- Helps users identify what they uploaded

### `stored_file_name`
The path/filename in Supabase Storage (e.g., "test-bank/user123_1729708800000.pdf")
- Used for storage reference
- Generated by the system: `{userId}_{timestamp}.{extension}`
- Used to retrieve files from storage

### `file_name` (if still in schema)
Legacy column - may need to be removed or can be used as a fallback

## Testing

✅ **Insert Operation:** Now uses correct columns  
✅ **Fetch Operation:** Retrieves correct data  
✅ **Type Safety:** Interface matches database schema  
✅ **Display:** Shows original filename to users

## Related Migration
The migration file at `supabase/migrations/20250824_create_test_bank_table.sql` shows older schema. The actual database schema has evolved beyond the migration file. Consider creating a new migration to document the current schema or updating the existing one.

---

**Fixed:** October 23, 2025  
**Status:** ✅ Complete - Test bank submissions should now work correctly
